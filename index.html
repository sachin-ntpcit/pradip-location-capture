<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRADIP - Location Capture</title>

<style>
body{
    font-family: Segoe UI, Arial, sans-serif;
    background: linear-gradient(135deg,#1e3c72,#2a5298);
    min-height:80vh;
    display:flex;
    align-items:center;
    justify-content:center;
}
.box{
    background:#fff;
    padding:40px;
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
    text-align:center;
    width:90%;
    max-width:700px;
}
button{
    padding:16px 36px;
    font-size:18px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    background:#1e3c72;
    color:#fff;
    font-weight:600;
}
iframe{
    width:100%;
    min-height:800px;
    border:none;
    border-radius:16px;
    margin-top:20px;
    display:none;
}
</style>
</head>

<body>

<div class="box">
    <h2>PRADIP-Infra Status</h2>
    <h3>üìç Click To Capture Location</h3>
    <!--<p>Click the button to continue to the form</p>-->

    <button id="captureBtn" onclick="start()">Capture Location</button>

    <iframe id="formFrame"></iframe>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbzHzIbJqPTFi3NGwqOKFUH5iGOkVCY_dA8Y3xAK04DDXUgnYiXihdpayeOolizE1EiOWQ/exec";

const FORM_BASE =
  "https://docs.google.com/forms/d/e/1FAIpQLSdnZQ0a0499eiegMd34Qq3_9ggogvPjk8c9TQiMn8qUCy8T_Q/viewform";

const sessionId = "SID-" + Date.now() + "-" + Math.floor(Math.random()*10000);

const FORM_URL =
  FORM_BASE + "?usp=pp_url&entry.1679097510=" + encodeURIComponent(sessionId);

function start(){
  document.getElementById("captureBtn").style.display="none";

  const frame = document.getElementById("formFrame");
  frame.src = FORM_URL;
  frame.style.display="block";

  if (!navigator.geolocation) {
    sendToSheet("Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      let address = "";

      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,
          {
            headers: { "User-Agent": "PRADIP-Location-Capture/1.0" }
          }
        );
        const data = await res.json();
        address = data.display_name || "";
      } catch (e) {
        address = "";
      }

      const fullLocation =
        (address ? address + "\n" : "") +
        `(Lat: ${lat}, Lng: ${lng})`;

      sendToSheet(fullLocation);
    },
    () => {
      sendToSheet("Location permission denied / unavailable");
    },
    { enableHighAccuracy:true, timeout:15000 }
  );
}

function sendToSheet(locationText){
  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      sessionId: sessionId,
      location: locationText
    })
  });
}
</script>

</body>
</html>
